import java.rmi.*;
import java.rmi.registry.LocateRegistry;
import java.rmi.server.UnicastRemoteObject;
import java.sql.*;

// ---------- RMI INTERFACE ----------
interface DBService extends Remote {
    int getUserCount() throws RemoteException;
}

// ---------- RMI IMPLEMENTATION + JDBC ----------
public class RmiJdbcDemo extends UnicastRemoteObject implements DBService {

    protected RmiJdbcDemo() throws RemoteException {}

    @Override
    public int getUserCount() throws RemoteException {
        int count = 0;

        // JDBC SETTINGS
        String url = "jdbc:mysql://localhost:3306/testdb";
        String user = "root";
        String pass = "yourpassword";

        try {
            Class.forName("com.mysql.cj.jdbc.Driver");

            Connection con = DriverManager.getConnection(url, user, pass);
            PreparedStatement ps = con.prepareStatement("SELECT COUNT(*) FROM users");
            ResultSet rs = ps.executeQuery();

            if (rs.next()) {
                count = rs.getInt(1);
            }

            con.close();
        } catch (Exception e) {
            e.printStackTrace();
        }

        return count;
    }

    // ---------- MAIN (SERVER + CLIENT IN SAME FILE) ----------
    public static void main(String[] args) {

        try {
            // Start RMI Registry
            LocateRegistry.createRegistry(1099);
            System.out.println("RMI Registry started...");

            // Create service + bind
            DBService service = new RmiJdbcDemo();
            Naming.rebind("rmi://localhost:1099/db", service);

            System.out.println("RMI JDBC Server Ready!");

            // ---- CLIENT CALL FROM SAME FILE ----
            DBService client = (DBService) Naming.lookup("rmi://localhost:1099/db");
            int count = client.getUserCount();

            System.out.println("User Count from Database = " + count);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}


CREATE DATABASE testdb;
USE testdb;

CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50)
);
